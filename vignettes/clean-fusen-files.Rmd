---
title: "Clean {fusen} files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{clean-fusen-files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(fusen)
```

<!-- WARNING - This vignette is generated by {fusen} from /dev/flat_clean_fusen_files.Rmd: do not edit by hand -->

## {fusen} helps you clean your old functions and tests files

{fusen} inflates your flat files to pre-defined script names in the correct place, so that you do not have to think about it. If you do not change the default behaviour, scripts names are created from the name of each function created.  
Until version 0.4, if you decided to change the name of your function, or a function was obsolete, you had to clean it all manually.  
This time is over with {fusen} version >0.5!  
Now, {fusen} keeps track of files created with an `inflate()`, in a yaml configuration file. It also allows you to register all extra files that you think are legitimate. 
Hence, {fusen} will be able to clean all files that are not necessary anymore in your package.


## How to migrate from previous {fusen} versions?

This vignette shows tools that are used internally to {fusen} to keep track of all files created during the `inflate()` process. 
They are exported for users who start using {fusen} >= 0.5, in a package built without {fusen}, or with earlier versions of {fusen}.  

The recommended process for a migration is:  

- Run `check_not_registered_files()` on your package
- Open the "dev/config_not_registered.csv" file
  + The csv contains all existing "R/", "tests/" and "vignettes/" files
  + If you used earlier version of {fusen}, the csv may list the flat file of origin
- Clean or modify the csv file
  + Let `origin = "keep"` for files to keep, that are not coming from a flat file
- Run `df_to_config()`


# Keep it all, I am sure of the current state

If all files of the current state are legitimate, then, you can register everything in the config file.

{fusen} will try to guess the source flat file of each script. This will only be possible if you used {fusen} >= 0.4 before. Otherwise, you may want to follow the detailed process in the other sections.

Run `register_all_to_config()` in your current package to create the "dev/fusen_config.yaml" that registers all your files. You will note a "keep" section, which lists all files for which the source was not guessed.
    

  

```{r example-register_all_to_config-1, eval = FALSE}
#' \dontrun{
# Usually run this one inside the current project
register_all_to_config()
#' }
```

```{rexample -register_all_to_config-2, eval = TRUE}
# Or you can try on the reproducible example
dummypackage <- tempfile("register")
dir.create(dummypackage)

# {fusen} steps
fill_description(pkg = dummypackage, fields = list(Title = "Dummy Package"))
dev_file <- suppressMessages(add_flat_template(pkg = dummypackage, overwrite = TRUE, open = FALSE))
flat_file <- dev_file[grepl("flat_", dev_file)]
# Inflate once
suppressMessages(
  inflate(
    pkg = dummypackage, flat_file = flat_file,
    vignette_name = "Get started", check = FALSE,
    open_vignette = FALSE
  )
)
usethis::with_project(dummypackage, {
  out_path <- register_all_to_config(dummypackage)
})
# Look at the output
yaml::read_yaml(out_path)
```

  

  


### Protect existing R, tests and vignettes files

`df_to_config()` allows to add your own list of files that you want to `keep` in your package, despite not beeing created with a flat file.  
This is important if you started to develop without {fusen}, and start using a flat file from now on, so that {fusen} does not delete your existing files.


```{r examples-df_to_config, eval = FALSE}
# Add your own list of files to "keep",
# if they are not in a flat file.
# Otherwise, they may be deleted with your next `inflate()`
my_files_to_protect <- tibble::tribble(
  ~type, ~path,
  "R", "R/zaza.R",
  "R", "R/zozo.R",
  "test", "tests/testthat/test-zaza.R",
  "vignette", "vignettes/my-zaza-vignette.Rmd"
)

# \dontrun{
df_to_config(my_files_to_protect)
# }
```

## List files that are not registered in config

    
{fusen} now registers all files created during `inflate()`. 
This allows to clean the packages directories in case some functions do not exist anymore and were renamed.  
However, this also requires to register all existing files if you started your package without {fusen} or with an earlier version of {fusen}.  
`check_not_registered_files()` shows files that are not already registered in the yaml config file. The output is consistent with what is needed for `df_to_config()` to register them if wanted.  
Note that `check_not_registered_files()` will try to guess the source flat template, if you used {fusen} >= 0.4 before.


  

```{r example-check_not_registered_files, eval = FALSE}
#' \dontrun{
# Run this on the current package in development
out_csv <- check_not_registered_files()
out_csv
#' }
```

```{r example2-check_not_registered_files, eval = TRUE}
# Or you can try on the reproducible example
dummypackage <- tempfile("clean")
dir.create(dummypackage)

# {fusen} steps
fill_description(pkg = dummypackage, fields = list(Title = "Dummy Package"))
dev_file <- suppressMessages(add_flat_template(pkg = dummypackage, overwrite = TRUE, open = FALSE))
flat_file <- dev_file[grepl("flat_", dev_file)]
# Inflate once
suppressMessages(
  inflate(
    pkg = dummypackage, flat_file = flat_file,
    vignette_name = "Get started", check = FALSE,
    open_vignette = FALSE
  )
)
# Add a not registered file to the package
cat("# test R file", file = file.path(dummypackage, "R", "to_keep.R"))
  
# Use the fonction to check the list of files
out_csv <- check_not_registered_files(dummypackage)
out_csv
# Modify manually the list of files in the csv created
# Then read the file to add to the config file
content_csv <- read.csv(out_csv)
out_config <- df_to_config(df_files = out_csv)
out_config
# Open the out_config file to see what's going on
```

  

# clean_fusen_files

    

  

```{r example-clean_fusen_files}
clean_fusen_files()
```

  

  


