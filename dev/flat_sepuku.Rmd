---
title: "flat_sepuku.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# sepuku

```{r function-sepuku}
#' sepuku Title
#'
#' @return 1
#' @export
#'
#' @examples
sepuku <- function(
    pkg = ".") {
  if (!dir.exists(file.path(pkg, "dev"))) {
    cli::cli_abort("No dev/ folder have been found. Are you sure that your package has been initiated with fusen ?")
  }

  config_file <- getOption("fusen.config_file", default = "dev/config_fusen.yaml")

  if (!file.exists(config_file)) {
    cli::cli_alert_info("No fusen configuration file found. The flat files to be deleted will be identified as files starting with 'flat' in the dev/ folder.")
  } else {
    cli::cli_alert_info("A fusen configuration file was found. The flat files to be deleted will be identified as files listed in this configuration file as well as those starting with 'flat' in the dev/ folder.")
  }
}
```

```{r examples-sepuku}
sepuku()
```

```{r tests-sepuku}
dummypackage <- tempfile("sepuku.first")
dir.create(dummypackage)
fill_description(pkg = dummypackage, fields = list(Title = "Dummy Package"))

test_that("sepuku is a function", {
  expect_true(inherits(sepuku, "function"))
})

usethis::with_project(dummypackage, {
  # Add licence
  usethis::use_mit_license("John Doe")

  test_that("sepuku checks that a dev/ folder exists", {
    #  Check for a dev folder
    expect_error(
      sepuku(), "No dev/ folder have been found. Are you sure that your package has been initiated with fusen ?"
    )
  })

  dev_file <- suppressMessages(add_minimal_package(overwrite = TRUE, open = FALSE))

  test_that("sepuku checks whether a fusen config file exists or not", {
    expect_message(
      sepuku(), "No fusen configuration file found. The flat files to be deleted will be identified as files starting with 'flat' in the dev/ folder."
    )

    # To add the config file a first inflate is needed
    flat_file <- dev_file[grepl("flat_", dev_file)]

    suppressMessages(
      inflate(
        pkg = dummypackage, flat_file = flat_file,
        vignette_name = "Get started", check = FALSE,
        open_vignette = FALSE, document = TRUE,
        overwrite = "yes"
      )
    )

    expect_message(
      sepuku(), "A fusen configuration file was found. The flat files to be deleted will be identified as files listed in this configuration file as well as those starting with 'flat' in the dev/ folder."
    )
  })
})

unlink(dummypackage, recursive = TRUE)
```

```{r tests-sepuku}
dummypackage <- tempfile("sepuku.second")
dir.create(dummypackage)
fill_description(pkg = dummypackage, fields = list(Title = "Dummy Package"))

usethis::with_project(dummypackage, {
  # Add licence
  usethis::use_mit_license("John Doe")

  browser()
  test_that("sepuku raises a message if no flat files have been found", {
    #  Check for a dev folder
    expect_error(
      sepuku(), "No dev/ folder have been found. Are you sure that your package has been initiated with fusen ?"
    )
  })

  dev_file <- suppressMessages(add_minimal_package(overwrite = TRUE, open = FALSE))

  test_that("sepuku checks whether a fusen config file exists or not", {
    expect_message(
      sepuku(), "No fusen configuration file found. The flat files to be deleted will be identified as files starting with 'flat' in the dev/ folder."
    )

    # To add the config file a first inflate is needed
    flat_file <- dev_file[grepl("flat_", dev_file)]

    suppressMessages(
      inflate(
        pkg = dummypackage, flat_file = flat_file,
        vignette_name = "Get started", check = FALSE,
        open_vignette = FALSE, document = TRUE,
        overwrite = "yes"
      )
    )

    expect_message(
      sepuku(), "A fusen configuration file was found. The flat files to be deleted will be identified as files listed in this configuration file as well as those starting with 'flat' in the dev/ folder."
    )
  })
})

unlink(dummypackage, recursive = TRUE)
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_sepuku.Rmd", vignette_name = "Go further")
```

